<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>QHP, provider, and formulary coverage JSON validator</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <style>
            textarea[name=json] { font-family: monospace; font-size: 12px; }
            .errors p { padding: 15px; }
            h2 small { color: #c00; font-size: smaller; }
            .beta { color: green; font-family: monospace; }
            .help { color: grey; font-size: smaller; }
            .spinner { max-height: 32px; max-width: 32px; }
            .file-errors-more {display: none;}
            .file-errors-more.expanded {display: inline;}
            #show-more-link {display: none;}            
        </style>
    </head>
    <body>
        <div class="container">
            <h2>QHP, provider, and formulary coverage JSON validator</h2>
            <h3 class="beta">BETA - 2017 schema</h3>
            <p>
                <a href="/docs">Click here for more information</a> | <a href="#helpBlock" class="example">Try an example</a>
            </p>
            <div class="row">
                <div class="col-md-7">
                    <form method="post" action="/validate" enctype="multipart/form-data">
                        <div class="form-group">
                            <h3>Validate a file</h3>
                            <label for="schema">JSON schema</label>
                            <select class="form-control" id="schema" name="schema" aria-describedby="schemaHelp">
                                <option value="plans" selected>Plans</option>
                                <option value="providers">Providers</option>
                                <option value="drugs">Drugs</option>
                                <option value="index">Index</option>
                            </select>
                            <span id="schemaHelp" class="help-block">The schema of the JSON document to be validated.</span>
                        </div>
                        <div class="form-group">
                            <label class="btn btn-default btn-file">
                                Select file <input id="file" type="file" style="display: none;">
                            </label>
			                <h5><p id="fileName"></p></h5>
                            <p class="help">
                                Click ‘validate’ to review the selected file. Please note that validation may take several minutes.
                            </p>
                            <div>
                                <button type="submit" class="btn btn-default" id="validate-file-btn">
                                    Validate
                                </button>
                                <img src="/static/spinner.gif" class="spinner" style="display: none">
                            </div>
                        </div>
                    </form>
                </div>
                 <div class="col-md-5 results">
                    <div class="file-error-status"></div>
                    <div class="file-errors"></div>                    
                    <div class="file-errors-more"></div>
                </div>
            </div>
            <hr>

            <div class="row">
                <div class="col-md-7">
                    <form id="textbox-form" method="post" action="/validate">
                        <div class="form-group">
                            <h3>Validate JSON Copy/Paste</h3>
                            <label for="schema">JSON schema</label>
                            <select class="form-control" id="schema" name="schema" aria-describedby="schemaHelp">
                                <option value="plans" selected>Plans</option>
                                <option value="providers">Providers</option>
                                <option value="drugs">Drugs</option>
                                <option value="index">Index</option>
                            </select>
                            <span id="schemaHelp" class="help-block">The schema of the JSON document to be validated.</span>
                        </div>
                        <div class="form-group">
                            <label for="json">JSON</label>
                            <textarea class="form-control" rows="20" id="json" name="json" aria-describedby="helpBlock" required></textarea>
                            <span id="helpBlock" class="help-block">Paste in your JSON here.</span>
                        </div>
                        <button type="submit" class="btn btn-default" id="validate-btn">Validate</button>
                    </form>
                </div>
                <div class="col-md-5 results">
                    <div class="error-status"></div>
                    <div class="errors"></div>
                </div>
            </div>
            <hr>
            <footer>
                <p>Dump schemas:
                <ul>
                    <li><a href="/schema/plans">Plans</a>
                    <li><a href="/schema/providers">Providers</a>
                    <li><a href="/schema/drugs">Drugs</a>
                    <li><a href="/schema/index">Index</a>
                </ul>
                <hr>
                <p align="center"><a href="https://github.com/adhocteam/qhp-validator">Fork this project on GitHub</a></p>
            </footer>
        </div>
        <script>
         $('#file').on('change', function() {
             var file = $(this)[0].files[0];
             if (file) {
                 $('#fileName').html("Selected " + file.name);
             } else {
                 $('#fileName').html('');
             }
         });

        $(function() {
            var valid = false;
            var schema = null;
            var errors = [];
            var submitted = false;
            var fileValidation = false;
            var example = null;

            $('form').submit(function(e) {
                e.preventDefault();
                var file = $('#file');
                var jsonText = $('#json');
                if (jsonText.val() === '' && file.val() !== '') {
                    schema = $('#schema').val();
                    var data = new FormData();
                    data.append('schema', schema);
                    data.append('json', file[0].files[0]);
                    var jqXhr = $.ajax({
                        type: "POST",
                        url: "/validate",
                        cache: false,
                        data: data,
                        contentType: false,
                        processData: false,
                        success: function(resp) {
                            valid = resp.valid;
                            errors = resp.errors;
                            schema = resp.schema;
                            submitted = true;
                            fileValidation = true;
                            render();
                        },
                        dataType: "json"
                        });
                    jqXhr.always(function() {
                        $('.spinner').hide();
                        $('#validate-file-btn, #json').prop('disabled', false);
                    });
                    $('.spinner').show();
                    $('#validate-file-btn, #json').prop('disabled', true);
                } else {
                    fileValidation = false;

                    var jqXhr = $.ajax({
                        type: "POST",
                        url: "/validate",
                        data: $(this).serialize(),
                        success: function(resp) {
                            valid = resp.valid;
                            errors = resp.errors;
                            schema = resp.schema;
                            fileValidation = false;
                            submitted = true;
                            render();
                        },
                        dataType: "json"
                    });
                    jqXhr.always(function() {
                        $('#validate-btn, #json').prop('disabled', false);
                    });
                    $('#validate-btn, #json').prop('disabled', true);
                }
            });

            $('.example').click(function(e) {
                e.preventDefault();
                var fn = function() {
                    $('[name="json"]').val(example);
                    $('[name="schema"]').val('plans');
                    $('#textbox-form').submit();
                };
                if (!example) {
                    $.get('/static/example.json', null, function(data, status, xhr) {
                        example = xhr.responseText;
                        fn();
                    });
                } else {
                    fn();
                }
                return false;
            });

            function render() {               
                var more = $('.file-errors-more')
                var moreErrorsList = '<ul class="text-danger">';
                if (submitted) {
                    var errorsTmpl = '';
                    var errorStatusTmpl = '<p class="' + (valid ? 'bg-success' : 'bg-danger') + '">This document is <b>' + (valid ? 'valid' : 'not valid') + '</b> ' + schema + ' JSON.';
                    if (!valid && errors && errors.length > 0) {
                        length = errors[0].split(";").length
                        errorStatusTmpl += '<p class="text-danger">' + length + ' ' + (length === 1 ? 'error' : 'errors') + ':</p>';
                        if (fileValidation) {
                            errorStatusTmpl += '<a href="#" id="show-more-link">Show More...</a>'                            
                        }                        
                        errorsTmpl += '<ul class="' + (valid ? 'text-success' : 'text-danger') + '">';

                        $(errors).each(function(i, err) {
				            var errorList = err.split(';');
                            for(var i in errorList) {
                                if (i > 10) {
                                    moreErrorsList += '<li>' + errorList[i];
                                } else {                                   
                                    errorsTmpl += '<li>' + errorList[i];
                                }
                            }
                        });
                    }
                    
                    if (fileValidation) {
                        $('.file-error-status').html(errorStatusTmpl);                        
                        if (length > 10) {
                            $('#show-more-link').toggle();
                        }
                        $('.file-errors').html(errorsTmpl);
                        more.html(moreErrorsList);
                    } else {
                        $('.error-status').html(errorStatusTmpl);
                        $('.errors').html(errorsTmpl);
                    }
                    $('#show-more-link').on("click", function() {
                        if (more.attr('class') === 'file-errors-more') {                            
                            more.addClass('file-errors-more expanded');
                            this.innerText = 'Show Less';
                        } else {
                            more.removeClass('file-errors-more expanded').addClass('file-errors-more');
                            this.innerText = 'Show More';
                        }
                    });
                }
            }

            render();
        });
        </script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-62877927-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
