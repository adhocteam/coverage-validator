<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>QHP, provider, and formulary coverage JSON validator</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <style>
            textarea[name=json] { font-family: monospace; font-size: 12px; }
            .errors p { padding: 15px; }
            h2 small { color: #c00; font-size: smaller; }
            .beta { color: green; font-family: monospace; }
            .help { color: grey; font-size: smaller; }
            .spinner { max-height: 32px; max-width: 32px; }
            .file-errors-more {display: none;}
            .file-errors-more.expanded {display: inline;}
            #show-more-link {display: none;}
            .file-warnings-more {display: none;}
            .file-warnings-more.expanded {display: inline;}
            #show-more-warnings-link {display: none;}
        </style>
    </head>
    <body>
        <div class="container">
            <h2>QHP, provider, and formulary coverage JSON validator</h2>
            <h3 class="beta">BETA</h3>
            <p>
                <a href="/docs">Click here for more information</a> | <a href="#helpBlock" class="example">Try an example</a>
            </p>
            <div class="row">
                <div class="col-md-7">
                    <form method="post" id="file-form" action="/validate" enctype="multipart/form-data">
                        <div class="form-group">
                            <h3>Validate a file</h3>
                            <label for="schema">JSON schema</label>
                            <select class="form-control" id="schema" name="schema" aria-describedby="schemaHelp">
                                <option value="plans" selected>Plans</option>
                                <option value="providers">Providers</option>
                                <option value="drugs">Drugs</option>
                                <option value="index">Index</option>
                            </select>
                            <span id="schemaHelp" class="help-block">The schema of the JSON document to be validated.</span>
                            <label for="schemaYear">Schema year</label>
                            <select class="form-control" id="schemaYear" name="schemaYear" aria-describedby="schemaYearHelp">
                                <option value="2017" selected>2017</option>
                                <option value="2016">2016</option>
                            </select>
                            <span id="schemaYearHelp" class="help-block">The schema year of the JSON document to be validated.</span>
                        </div>
                        <div class="form-group">
                            <label class="btn btn-default btn-file">
                                Select file <input id="file" type="file" style="display: none;">
                            </label>
                            <h5><p id="fileName"></p></h5>
                            <p class="help">
                                Click ‘validate’ to review the selected file. Please note that validation may take several minutes.
                            </p>
                            <div>
                                <button type="submit" class="btn btn-default" id="validate-file-btn">
                                    Validate
                                </button>
                                <img src="/static/spinner.gif" class="spinner" style="display: none">
                            </div>
                        </div>
                    </form>
                </div>
                 <div class="col-md-5 results">
                    <div class="file-status"></div>
                    <div class="file-warnings"></div>
                    <div class="file-warnings-more"></div>
                    <div class="file-error-status"></div>
                    <div class="file-errors"></div>
                    <div class="file-errors-more"></div>
                </div>
            </div>
            <hr>

            <div class="row">
                <div class="col-md-7">
                    <form id="textbox-form" method="post" action="/validate">
                        <div class="form-group">
                            <h3>Validate JSON Copy/Paste</h3>
                            <label for="schema">JSON schema</label>
                            <select class="form-control" id="schema" name="schema" aria-describedby="schemaHelp">
                                <option value="plans" selected>Plans</option>
                                <option value="providers">Providers</option>
                                <option value="drugs">Drugs</option>
                                <option value="index">Index</option>
                            </select>
                            <span id="schemaHelp" class="help-block">The schema of the JSON document to be validated.</span>
                            <label for="schemaYear">Schema Year</label>
                            <select class="form-control" id="schemaYear" name="schemaYear" aria-describedby="schemaYearHelp">
                                <option value="2017" selected>2017</option>
                                <option value="2016">2016</option>
                            </select>
                            <span id="schemaYearHelp" class="help-block">The schema Year of the JSON document to be validated.</span>
                        </div>
                        <div class="form-group">
                            <label for="json">JSON</label>
                            <textarea class="form-control" rows="20" id="json" name="json" aria-describedby="helpBlock" required></textarea>
                            <span id="helpBlock" class="help-block">Paste in your JSON here.</span>
                        </div>
                        <button type="submit" class="btn btn-default" id="validate-btn">Validate</button>
                    </form>
                </div>
                <div class="col-md-5 results">
                    <div class="status"></div>
                    <div class="warnings"></div>
                    <div class="error-status"></div>
                    <div class="errors"></div>
                </div>
            </div>
            <hr>
            <footer>
                <p>Dump schemas:
                <ul>
                    <li><a href="/schema/plans">Plans</a>
                    <li><a href="/schema/providers">Providers</a>
                    <li><a href="/schema/drugs">Drugs</a>
                    <li><a href="/schema/index">Index</a>
                </ul>
                <hr>
                <p align="center"><a href="https://github.com/adhocteam/qhp-validator">Fork this project on GitHub</a></p>
            </footer>
        </div>
        <script>
         $('#file').on('change', function() {
             var file = $(this)[0].files[0];
             if (file) {
                 $('#fileName').html("Selected " + file.name);
             } else {
                 $('#fileName').html('');
             }
         });

        $(function() {
            var valid = false;
            var schema = null;
            var schemaYear = null;
            var errors = [];
            var warnings = [];
            var submitted = false;
            var fileValidation = false;
            var example = null;

            $('#file-form').submit(function(e) {
                e.preventDefault();
                var file = $('#file');
                var jsonText = $('#json');

                schema = $('#schema').val();
                schemaYear = $('#schemaYear').val();
                var data = new FormData();
                // order matters here, json must be last
                data.append('schema', schema);
                data.append('schemaYear', schemaYear);
                data.append('json', file[0].files[0]);
                var jqXhr = $.ajax({
                    type: "POST",
                    url: "/validate",
                    cache: false,
                    data: data,
                    contentType: false,
                    processData: false,
                    success: function(resp) {
                        valid = resp.valid;
                        errors = resp.errors;
                        warnings = resp.warnings;
                        schema = resp.schema;
                        submitted = true;
                        fileValidation = true;
                        render();
                    },
                    dataType: "json"
                });
                jqXhr.always(function(data, status, error) {
                    $('.spinner').hide();
                    $('#validate-file-btn, #json').prop('disabled', false);
                    $('#validate-btn, #json').prop('disabled', false);
                });
                $('.spinner').show();
                $('#validate-file-btn, #json').prop('disabled', true);
                $('#validate-btn, #json').prop('disabled', true);
            });
            $('#textbox-form').submit(function(e) {
                e.preventDefault();
                var file = $('#file');
                var jsonText = $('#json');
                fileValidation = false;

                var jqXhr = $.ajax({
                    type: "POST",
                    url: "/validate",
                    data: $(this).serialize(),
                    success: function(resp) {
                        valid = resp.valid;
                        errors = resp.errors;
                        schema = resp.schema;
                        warnings = resp.warnings;
                        fileValidation = false;
                        submitted = true;
                        render();
                    },
                    dataType: "json"
                });
                jqXhr.always(function() {
                    $('#validate-btn, #json').prop('disabled', false);
                    $('#validate-file-btn, #json').prop('disabled', false);
                });
                $('#validate-btn, #json').prop('disabled', true);
                $('#validate-file-btn, #json').prop('disabled', true);
            });

            $('.example').click(function(e) {
                e.preventDefault();
                var fn = function() {
                    $('[name="json"]').val(example);
                    $('[name="schema"]').val('plans');
                    $('#textbox-form').submit();
                };
                if (!example) {
                    $.get('/static/example.json', null, function(data, status, xhr) {
                        example = xhr.responseText;
                        fn();
                    });
                } else {
                    fn();
                }
                return false;
            });

            function render() {
                var moreWarnings = $('.file-warnings-more');
                var moreWarningsList = '<ul class="text-warning">';
                var more = $('.file-errors-more');
                var moreErrorsList = '<ul class="text-danger">';
                if (submitted) {
                    var errorsTmpl = '';
                    var statusTmpl = '<p class="' + (valid ? 'bg-success' : 'bg-danger') + '">This document is <b>' +
                        (valid ? 'valid' : 'not valid') + '</b> ' + schema + ' JSON.';
                    var warningsTmpl = '';
                    var errorStatusTmpl = '';
                    if (warnings && warnings.length > 0) {
                        var warningsStatusTmpl = '<p class="text-warning">This document has ' + warnings.length + ' ' + (warnings.length === 1 ? 'warning' : 'warnings') + ':</p>';
                        if (fileValidation) {
                            warningsStatusTmpl += '<a href="#" id="show-more-warnings-link">Show more &hellip;</a>';
                        }
                        warningsTmpl += '<ul class="text-warning">';
                        $(warnings).each(function(i, warning) {
                            if (i >= 10) {
                                moreWarningsList += '<li>' + warning;
                            } else {
                                warningsTmpl += '<li>' + warning;
                            }
                        });
                        statusTmpl += warningsStatusTmpl;
                    }
                    if (!valid && errors && errors.length > 0) {
                        errorStatusTmpl += '<p class="text-danger">' + errors.length + ' ' + (errors.length === 1 ? 'error' : 'errors') + ':</p>';
                        if (fileValidation) {
                            errorStatusTmpl += '<a href="#" id="show-more-link">Show more &hellip;</a>';
                        }
                        errorsTmpl += '<ul class="' + (valid ? 'text-success' : 'text-danger') + '">';

                        $(errors).each(function(i, err) {
                            if (i >= 10) {
                                moreErrorsList += '<li>' + err;
                            } else {
                                errorsTmpl += '<li>' + err;
                            }
                        });
                    }

                    if (fileValidation) {
                        $('.file-status').html(statusTmpl);
                        $('.file-warnings').html(warningsTmpl);
                        moreWarnings.html(moreWarningsList);

                        $('.file-errors').html(errorsTmpl);
                        more.html(moreErrorsList);
                        if (warnings.length > 10) {
                            $('#show-more-warnings-link').toggle();
                        }
                        $('.file-error-status').html(errorStatusTmpl)
                        if (errors.length > 10) {
                            $('#show-more-link').toggle();
                        }
                    } else {
                        $('.status').html(statusTmpl);
                        $('.warnings').html(warningsTmpl);
                        $('.error-status').html(errorStatusTmpl)
                        $('.errors').html(errorsTmpl);
                    }

                    $('#show-more-link').on("click", function() {
                        if (!more.hasClass('expanded')) {
                            more.addClass('expanded');
                            $(this).html('Show fewer &hellip;');
                        } else {
                            more.removeClass('expanded');
                            $(this).html('Show more &hellip;');
                        }
                    });
                    $('#show-more-warnings-link').on("click", function() {
                        if (!moreWarnings.hasClass('expanded')) {
                            moreWarnings.addClass('expanded');
                            $(this).html('Show fewer &hellip;');
                        } else {
                            moreWarnings.removeClass('expanded');
                            $(this).html('Show more &hellip;');
                        }
                    });
                }
            }

            render();
        });
        </script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-62877927-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
